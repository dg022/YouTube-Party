{"ast":null,"code":"/**\n * Module dependencies.\n */\nvar Emitter = require('events').EventEmitter;\n\nvar parser = require('socket.io-parser');\n\nvar hasBin = require('has-binary2');\n\nvar url = require('url');\n\nvar debug = require('debug')('socket.io:socket');\n/**\n * Module exports.\n */\n\n\nmodule.exports = exports = Socket;\n/**\n * Blacklisted events.\n *\n * @api public\n */\n\nexports.events = ['error', 'connect', 'disconnect', 'disconnecting', 'newListener', 'removeListener'];\n/**\n * Flags.\n *\n * @api private\n */\n\nvar flags = ['json', 'volatile', 'broadcast', 'local'];\n/**\n * `EventEmitter#emit` reference.\n */\n\nvar emit = Emitter.prototype.emit;\n/**\n * Interface to a `Client` for a given `Namespace`.\n *\n * @param {Namespace} nsp\n * @param {Client} client\n * @api public\n */\n\nfunction Socket(nsp, client, query) {\n  this.nsp = nsp;\n  this.server = nsp.server;\n  this.adapter = this.nsp.adapter;\n  this.id = nsp.name !== '/' ? nsp.name + '#' + client.id : client.id;\n  this.client = client;\n  this.conn = client.conn;\n  this.rooms = {};\n  this.acks = {};\n  this.connected = true;\n  this.disconnected = false;\n  this.handshake = this.buildHandshake(query);\n  this.fns = [];\n  this.flags = {};\n  this._rooms = [];\n}\n/**\n * Inherits from `EventEmitter`.\n */\n\n\nSocket.prototype.__proto__ = Emitter.prototype;\n/**\n * Apply flags from `Socket`.\n */\n\nflags.forEach(function (flag) {\n  Object.defineProperty(Socket.prototype, flag, {\n    get: function () {\n      this.flags[flag] = true;\n      return this;\n    }\n  });\n});\n/**\n * `request` engine.io shortcut.\n *\n * @api public\n */\n\nObject.defineProperty(Socket.prototype, 'request', {\n  get: function () {\n    return this.conn.request;\n  }\n});\n/**\n * Builds the `handshake` BC object\n *\n * @api private\n */\n\nSocket.prototype.buildHandshake = function (query) {\n  var self = this;\n\n  function buildQuery() {\n    var requestQuery = url.parse(self.request.url, true).query; //if socket-specific query exist, replace query strings in requestQuery\n\n    return Object.assign({}, query, requestQuery);\n  }\n\n  return {\n    headers: this.request.headers,\n    time: new Date() + '',\n    address: this.conn.remoteAddress,\n    xdomain: !!this.request.headers.origin,\n    secure: !!this.request.connection.encrypted,\n    issued: +new Date(),\n    url: this.request.url,\n    query: buildQuery()\n  };\n};\n/**\n * Emits to this client.\n *\n * @return {Socket} self\n * @api public\n */\n\n\nSocket.prototype.emit = function (ev) {\n  if (~exports.events.indexOf(ev)) {\n    emit.apply(this, arguments);\n    return this;\n  }\n\n  var args = Array.prototype.slice.call(arguments);\n  var packet = {\n    type: (this.flags.binary !== undefined ? this.flags.binary : hasBin(args)) ? parser.BINARY_EVENT : parser.EVENT,\n    data: args\n  }; // access last argument to see if it's an ACK callback\n\n  if (typeof args[args.length - 1] === 'function') {\n    if (this._rooms.length || this.flags.broadcast) {\n      throw new Error('Callbacks are not supported when broadcasting');\n    }\n\n    debug('emitting packet with ack id %d', this.nsp.ids);\n    this.acks[this.nsp.ids] = args.pop();\n    packet.id = this.nsp.ids++;\n  }\n\n  var rooms = this._rooms.slice(0);\n\n  var flags = Object.assign({}, this.flags); // reset flags\n\n  this._rooms = [];\n  this.flags = {};\n\n  if (rooms.length || flags.broadcast) {\n    this.adapter.broadcast(packet, {\n      except: [this.id],\n      rooms: rooms,\n      flags: flags\n    });\n  } else {\n    // dispatch packet\n    this.packet(packet, flags);\n  }\n\n  return this;\n};\n/**\n * Targets a room when broadcasting.\n *\n * @param {String} name\n * @return {Socket} self\n * @api public\n */\n\n\nSocket.prototype.to = Socket.prototype.in = function (name) {\n  if (!~this._rooms.indexOf(name)) this._rooms.push(name);\n  return this;\n};\n/**\n * Sends a `message` event.\n *\n * @return {Socket} self\n * @api public\n */\n\n\nSocket.prototype.send = Socket.prototype.write = function () {\n  var args = Array.prototype.slice.call(arguments);\n  args.unshift('message');\n  this.emit.apply(this, args);\n  return this;\n};\n/**\n * Writes a packet.\n *\n * @param {Object} packet object\n * @param {Object} opts options\n * @api private\n */\n\n\nSocket.prototype.packet = function (packet, opts) {\n  packet.nsp = this.nsp.name;\n  opts = opts || {};\n  opts.compress = false !== opts.compress;\n  this.client.packet(packet, opts);\n};\n/**\n * Joins a room.\n *\n * @param {String|Array} room or array of rooms\n * @param {Function} fn optional, callback\n * @return {Socket} self\n * @api private\n */\n\n\nSocket.prototype.join = function (rooms, fn) {\n  debug('joining room %s', rooms);\n  var self = this;\n\n  if (!Array.isArray(rooms)) {\n    rooms = [rooms];\n  }\n\n  rooms = rooms.filter(function (room) {\n    return !self.rooms.hasOwnProperty(room);\n  });\n\n  if (!rooms.length) {\n    fn && fn(null);\n    return this;\n  }\n\n  this.adapter.addAll(this.id, rooms, function (err) {\n    if (err) return fn && fn(err);\n    debug('joined room %s', rooms);\n    rooms.forEach(function (room) {\n      self.rooms[room] = room;\n    });\n    fn && fn(null);\n  });\n  return this;\n};\n/**\n * Leaves a room.\n *\n * @param {String} room\n * @param {Function} fn optional, callback\n * @return {Socket} self\n * @api private\n */\n\n\nSocket.prototype.leave = function (room, fn) {\n  debug('leave room %s', room);\n  var self = this;\n  this.adapter.del(this.id, room, function (err) {\n    if (err) return fn && fn(err);\n    debug('left room %s', room);\n    delete self.rooms[room];\n    fn && fn(null);\n  });\n  return this;\n};\n/**\n * Leave all rooms.\n *\n * @api private\n */\n\n\nSocket.prototype.leaveAll = function () {\n  this.adapter.delAll(this.id);\n  this.rooms = {};\n};\n/**\n * Called by `Namespace` upon successful\n * middleware execution (ie: authorization).\n * Socket is added to namespace array before\n * call to join, so adapters can access it.\n *\n * @api private\n */\n\n\nSocket.prototype.onconnect = function () {\n  debug('socket connected - writing packet');\n  this.nsp.connected[this.id] = this;\n  this.join(this.id);\n  var skip = this.nsp.name === '/' && this.nsp.fns.length === 0;\n\n  if (skip) {\n    debug('packet already sent in initial handshake');\n  } else {\n    this.packet({\n      type: parser.CONNECT\n    });\n  }\n};\n/**\n * Called with each packet. Called by `Client`.\n *\n * @param {Object} packet\n * @api private\n */\n\n\nSocket.prototype.onpacket = function (packet) {\n  debug('got packet %j', packet);\n\n  switch (packet.type) {\n    case parser.EVENT:\n      this.onevent(packet);\n      break;\n\n    case parser.BINARY_EVENT:\n      this.onevent(packet);\n      break;\n\n    case parser.ACK:\n      this.onack(packet);\n      break;\n\n    case parser.BINARY_ACK:\n      this.onack(packet);\n      break;\n\n    case parser.DISCONNECT:\n      this.ondisconnect();\n      break;\n\n    case parser.ERROR:\n      this.onerror(new Error(packet.data));\n  }\n};\n/**\n * Called upon event packet.\n *\n * @param {Object} packet object\n * @api private\n */\n\n\nSocket.prototype.onevent = function (packet) {\n  var args = packet.data || [];\n  debug('emitting event %j', args);\n\n  if (null != packet.id) {\n    debug('attaching ack callback to event');\n    args.push(this.ack(packet.id));\n  }\n\n  this.dispatch(args);\n};\n/**\n * Produces an ack callback to emit with an event.\n *\n * @param {Number} id packet id\n * @api private\n */\n\n\nSocket.prototype.ack = function (id) {\n  var self = this;\n  var sent = false;\n  return function () {\n    // prevent double callbacks\n    if (sent) return;\n    var args = Array.prototype.slice.call(arguments);\n    debug('sending ack %j', args);\n    self.packet({\n      id: id,\n      type: hasBin(args) ? parser.BINARY_ACK : parser.ACK,\n      data: args\n    });\n    sent = true;\n  };\n};\n/**\n * Called upon ack packet.\n *\n * @api private\n */\n\n\nSocket.prototype.onack = function (packet) {\n  var ack = this.acks[packet.id];\n\n  if ('function' == typeof ack) {\n    debug('calling ack %s with %j', packet.id, packet.data);\n    ack.apply(this, packet.data);\n    delete this.acks[packet.id];\n  } else {\n    debug('bad ack %s', packet.id);\n  }\n};\n/**\n * Called upon client disconnect packet.\n *\n * @api private\n */\n\n\nSocket.prototype.ondisconnect = function () {\n  debug('got disconnect packet');\n  this.onclose('client namespace disconnect');\n};\n/**\n * Handles a client error.\n *\n * @api private\n */\n\n\nSocket.prototype.onerror = function (err) {\n  if (this.listeners('error').length) {\n    this.emit('error', err);\n  } else {\n    console.error('Missing error handler on `socket`.');\n    console.error(err.stack);\n  }\n};\n/**\n * Called upon closing. Called by `Client`.\n *\n * @param {String} reason\n * @throw {Error} optional error object\n * @api private\n */\n\n\nSocket.prototype.onclose = function (reason) {\n  if (!this.connected) return this;\n  debug('closing socket - reason %s', reason);\n  this.emit('disconnecting', reason);\n  this.leaveAll();\n  this.nsp.remove(this);\n  this.client.remove(this);\n  this.connected = false;\n  this.disconnected = true;\n  delete this.nsp.connected[this.id];\n  this.emit('disconnect', reason);\n};\n/**\n * Produces an `error` packet.\n *\n * @param {Object} err error object\n * @api private\n */\n\n\nSocket.prototype.error = function (err) {\n  this.packet({\n    type: parser.ERROR,\n    data: err\n  });\n};\n/**\n * Disconnects this client.\n *\n * @param {Boolean} close if `true`, closes the underlying connection\n * @return {Socket} self\n * @api public\n */\n\n\nSocket.prototype.disconnect = function (close) {\n  if (!this.connected) return this;\n\n  if (close) {\n    this.client.disconnect();\n  } else {\n    this.packet({\n      type: parser.DISCONNECT\n    });\n    this.onclose('server namespace disconnect');\n  }\n\n  return this;\n};\n/**\n * Sets the compress flag.\n *\n * @param {Boolean} compress if `true`, compresses the sending data\n * @return {Socket} self\n * @api public\n */\n\n\nSocket.prototype.compress = function (compress) {\n  this.flags.compress = compress;\n  return this;\n};\n/**\n * Sets the binary flag\n *\n * @param {Boolean} Encode as if it has binary data if `true`, Encode as if it doesnt have binary data if `false`\n * @return {Socket} self\n * @api public\n */\n\n\nSocket.prototype.binary = function (binary) {\n  this.flags.binary = binary;\n  return this;\n};\n/**\n * Dispatch incoming event to socket listeners.\n *\n * @param {Array} event that will get emitted\n * @api private\n */\n\n\nSocket.prototype.dispatch = function (event) {\n  debug('dispatching an event %j', event);\n  var self = this;\n\n  function dispatchSocket(err) {\n    process.nextTick(function () {\n      if (err) {\n        return self.error(err.data || err.message);\n      }\n\n      emit.apply(self, event);\n    });\n  }\n\n  this.run(event, dispatchSocket);\n};\n/**\n * Sets up socket middleware.\n *\n * @param {Function} middleware function (event, next)\n * @return {Socket} self\n * @api public\n */\n\n\nSocket.prototype.use = function (fn) {\n  this.fns.push(fn);\n  return this;\n};\n/**\n * Executes the middleware for an incoming event.\n *\n * @param {Array} event that will get emitted\n * @param {Function} last fn call in the middleware\n * @api private\n */\n\n\nSocket.prototype.run = function (event, fn) {\n  var fns = this.fns.slice(0);\n  if (!fns.length) return fn(null);\n\n  function run(i) {\n    fns[i](event, function (err) {\n      // upon error, short-circuit\n      if (err) return fn(err); // if no middleware left, summon callback\n\n      if (!fns[i + 1]) return fn(null); // go on to next\n\n      run(i + 1);\n    });\n  }\n\n  run(0);\n};","map":{"version":3,"sources":["C:/Users/david/react/YouTubeClone/client/node_modules/socket.io/lib/socket.js"],"names":["Emitter","require","EventEmitter","parser","hasBin","url","debug","module","exports","Socket","events","flags","emit","prototype","nsp","client","query","server","adapter","id","name","conn","rooms","acks","connected","disconnected","handshake","buildHandshake","fns","_rooms","__proto__","forEach","flag","Object","defineProperty","get","request","self","buildQuery","requestQuery","parse","assign","headers","time","Date","address","remoteAddress","xdomain","origin","secure","connection","encrypted","issued","ev","indexOf","apply","arguments","args","Array","slice","call","packet","type","binary","undefined","BINARY_EVENT","EVENT","data","length","broadcast","Error","ids","pop","except","to","in","push","send","write","unshift","opts","compress","join","fn","isArray","filter","room","hasOwnProperty","addAll","err","leave","del","leaveAll","delAll","onconnect","skip","CONNECT","onpacket","onevent","ACK","onack","BINARY_ACK","DISCONNECT","ondisconnect","ERROR","onerror","ack","dispatch","sent","onclose","listeners","console","error","stack","reason","remove","disconnect","close","event","dispatchSocket","process","nextTick","message","run","use","i"],"mappings":"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","sourcesContent":["\n/**\n * Module dependencies.\n */\n\nvar Emitter = require('events').EventEmitter;\nvar parser = require('socket.io-parser');\nvar hasBin = require('has-binary2');\nvar url = require('url');\nvar debug = require('debug')('socket.io:socket');\n\n/**\n * Module exports.\n */\n\nmodule.exports = exports = Socket;\n\n/**\n * Blacklisted events.\n *\n * @api public\n */\n\nexports.events = [\n  'error',\n  'connect',\n  'disconnect',\n  'disconnecting',\n  'newListener',\n  'removeListener'\n];\n\n/**\n * Flags.\n *\n * @api private\n */\n\nvar flags = [\n  'json',\n  'volatile',\n  'broadcast',\n  'local'\n];\n\n/**\n * `EventEmitter#emit` reference.\n */\n\nvar emit = Emitter.prototype.emit;\n\n/**\n * Interface to a `Client` for a given `Namespace`.\n *\n * @param {Namespace} nsp\n * @param {Client} client\n * @api public\n */\n\nfunction Socket(nsp, client, query){\n  this.nsp = nsp;\n  this.server = nsp.server;\n  this.adapter = this.nsp.adapter;\n  this.id = nsp.name !== '/' ? nsp.name + '#' + client.id : client.id;\n  this.client = client;\n  this.conn = client.conn;\n  this.rooms = {};\n  this.acks = {};\n  this.connected = true;\n  this.disconnected = false;\n  this.handshake = this.buildHandshake(query);\n  this.fns = [];\n  this.flags = {};\n  this._rooms = [];\n}\n\n/**\n * Inherits from `EventEmitter`.\n */\n\nSocket.prototype.__proto__ = Emitter.prototype;\n\n/**\n * Apply flags from `Socket`.\n */\n\nflags.forEach(function(flag){\n  Object.defineProperty(Socket.prototype, flag, {\n    get: function() {\n      this.flags[flag] = true;\n      return this;\n    }\n  });\n});\n\n/**\n * `request` engine.io shortcut.\n *\n * @api public\n */\n\nObject.defineProperty(Socket.prototype, 'request', {\n  get: function() {\n    return this.conn.request;\n  }\n});\n\n/**\n * Builds the `handshake` BC object\n *\n * @api private\n */\n\nSocket.prototype.buildHandshake = function(query){\n  var self = this;\n  function buildQuery(){\n    var requestQuery = url.parse(self.request.url, true).query;\n    //if socket-specific query exist, replace query strings in requestQuery\n    return Object.assign({}, query, requestQuery);\n  }\n  return {\n    headers: this.request.headers,\n    time: (new Date) + '',\n    address: this.conn.remoteAddress,\n    xdomain: !!this.request.headers.origin,\n    secure: !!this.request.connection.encrypted,\n    issued: +(new Date),\n    url: this.request.url,\n    query: buildQuery()\n  };\n};\n\n/**\n * Emits to this client.\n *\n * @return {Socket} self\n * @api public\n */\n\nSocket.prototype.emit = function(ev){\n  if (~exports.events.indexOf(ev)) {\n    emit.apply(this, arguments);\n    return this;\n  }\n\n  var args = Array.prototype.slice.call(arguments);\n  var packet = {\n    type: (this.flags.binary !== undefined ? this.flags.binary : hasBin(args)) ? parser.BINARY_EVENT : parser.EVENT,\n    data: args\n  };\n\n  // access last argument to see if it's an ACK callback\n  if (typeof args[args.length - 1] === 'function') {\n    if (this._rooms.length || this.flags.broadcast) {\n      throw new Error('Callbacks are not supported when broadcasting');\n    }\n\n    debug('emitting packet with ack id %d', this.nsp.ids);\n    this.acks[this.nsp.ids] = args.pop();\n    packet.id = this.nsp.ids++;\n  }\n\n  var rooms = this._rooms.slice(0);\n  var flags = Object.assign({}, this.flags);\n\n  // reset flags\n  this._rooms = [];\n  this.flags = {};\n\n  if (rooms.length || flags.broadcast) {\n    this.adapter.broadcast(packet, {\n      except: [this.id],\n      rooms: rooms,\n      flags: flags\n    });\n  } else {\n    // dispatch packet\n    this.packet(packet, flags);\n  }\n  return this;\n};\n\n/**\n * Targets a room when broadcasting.\n *\n * @param {String} name\n * @return {Socket} self\n * @api public\n */\n\nSocket.prototype.to =\nSocket.prototype.in = function(name){\n  if (!~this._rooms.indexOf(name)) this._rooms.push(name);\n  return this;\n};\n\n/**\n * Sends a `message` event.\n *\n * @return {Socket} self\n * @api public\n */\n\nSocket.prototype.send =\nSocket.prototype.write = function(){\n  var args = Array.prototype.slice.call(arguments);\n  args.unshift('message');\n  this.emit.apply(this, args);\n  return this;\n};\n\n/**\n * Writes a packet.\n *\n * @param {Object} packet object\n * @param {Object} opts options\n * @api private\n */\n\nSocket.prototype.packet = function(packet, opts){\n  packet.nsp = this.nsp.name;\n  opts = opts || {};\n  opts.compress = false !== opts.compress;\n  this.client.packet(packet, opts);\n};\n\n/**\n * Joins a room.\n *\n * @param {String|Array} room or array of rooms\n * @param {Function} fn optional, callback\n * @return {Socket} self\n * @api private\n */\n\nSocket.prototype.join = function(rooms, fn){\n  debug('joining room %s', rooms);\n  var self = this;\n  if (!Array.isArray(rooms)) {\n    rooms = [rooms];\n  }\n  rooms = rooms.filter(function (room) {\n    return !self.rooms.hasOwnProperty(room);\n  });\n  if (!rooms.length) {\n    fn && fn(null);\n    return this;\n  }\n  this.adapter.addAll(this.id, rooms, function(err){\n    if (err) return fn && fn(err);\n    debug('joined room %s', rooms);\n    rooms.forEach(function (room) {\n      self.rooms[room] = room;\n    });\n    fn && fn(null);\n  });\n  return this;\n};\n\n/**\n * Leaves a room.\n *\n * @param {String} room\n * @param {Function} fn optional, callback\n * @return {Socket} self\n * @api private\n */\n\nSocket.prototype.leave = function(room, fn){\n  debug('leave room %s', room);\n  var self = this;\n  this.adapter.del(this.id, room, function(err){\n    if (err) return fn && fn(err);\n    debug('left room %s', room);\n    delete self.rooms[room];\n    fn && fn(null);\n  });\n  return this;\n};\n\n/**\n * Leave all rooms.\n *\n * @api private\n */\n\nSocket.prototype.leaveAll = function(){\n  this.adapter.delAll(this.id);\n  this.rooms = {};\n};\n\n/**\n * Called by `Namespace` upon successful\n * middleware execution (ie: authorization).\n * Socket is added to namespace array before\n * call to join, so adapters can access it.\n *\n * @api private\n */\n\nSocket.prototype.onconnect = function(){\n  debug('socket connected - writing packet');\n  this.nsp.connected[this.id] = this;\n  this.join(this.id);\n  var skip = this.nsp.name === '/' && this.nsp.fns.length === 0;\n  if (skip) {\n    debug('packet already sent in initial handshake');\n  } else {\n    this.packet({ type: parser.CONNECT });\n  }\n};\n\n/**\n * Called with each packet. Called by `Client`.\n *\n * @param {Object} packet\n * @api private\n */\n\nSocket.prototype.onpacket = function(packet){\n  debug('got packet %j', packet);\n  switch (packet.type) {\n    case parser.EVENT:\n      this.onevent(packet);\n      break;\n\n    case parser.BINARY_EVENT:\n      this.onevent(packet);\n      break;\n\n    case parser.ACK:\n      this.onack(packet);\n      break;\n\n    case parser.BINARY_ACK:\n      this.onack(packet);\n      break;\n\n    case parser.DISCONNECT:\n      this.ondisconnect();\n      break;\n\n    case parser.ERROR:\n      this.onerror(new Error(packet.data));\n  }\n};\n\n/**\n * Called upon event packet.\n *\n * @param {Object} packet object\n * @api private\n */\n\nSocket.prototype.onevent = function(packet){\n  var args = packet.data || [];\n  debug('emitting event %j', args);\n\n  if (null != packet.id) {\n    debug('attaching ack callback to event');\n    args.push(this.ack(packet.id));\n  }\n\n  this.dispatch(args);\n};\n\n/**\n * Produces an ack callback to emit with an event.\n *\n * @param {Number} id packet id\n * @api private\n */\n\nSocket.prototype.ack = function(id){\n  var self = this;\n  var sent = false;\n  return function(){\n    // prevent double callbacks\n    if (sent) return;\n    var args = Array.prototype.slice.call(arguments);\n    debug('sending ack %j', args);\n\n    self.packet({\n      id: id,\n      type: hasBin(args) ? parser.BINARY_ACK : parser.ACK,\n      data: args\n    });\n\n    sent = true;\n  };\n};\n\n/**\n * Called upon ack packet.\n *\n * @api private\n */\n\nSocket.prototype.onack = function(packet){\n  var ack = this.acks[packet.id];\n  if ('function' == typeof ack) {\n    debug('calling ack %s with %j', packet.id, packet.data);\n    ack.apply(this, packet.data);\n    delete this.acks[packet.id];\n  } else {\n    debug('bad ack %s', packet.id);\n  }\n};\n\n/**\n * Called upon client disconnect packet.\n *\n * @api private\n */\n\nSocket.prototype.ondisconnect = function(){\n  debug('got disconnect packet');\n  this.onclose('client namespace disconnect');\n};\n\n/**\n * Handles a client error.\n *\n * @api private\n */\n\nSocket.prototype.onerror = function(err){\n  if (this.listeners('error').length) {\n    this.emit('error', err);\n  } else {\n    console.error('Missing error handler on `socket`.');\n    console.error(err.stack);\n  }\n};\n\n/**\n * Called upon closing. Called by `Client`.\n *\n * @param {String} reason\n * @throw {Error} optional error object\n * @api private\n */\n\nSocket.prototype.onclose = function(reason){\n  if (!this.connected) return this;\n  debug('closing socket - reason %s', reason);\n  this.emit('disconnecting', reason);\n  this.leaveAll();\n  this.nsp.remove(this);\n  this.client.remove(this);\n  this.connected = false;\n  this.disconnected = true;\n  delete this.nsp.connected[this.id];\n  this.emit('disconnect', reason);\n};\n\n/**\n * Produces an `error` packet.\n *\n * @param {Object} err error object\n * @api private\n */\n\nSocket.prototype.error = function(err){\n  this.packet({ type: parser.ERROR, data: err });\n};\n\n/**\n * Disconnects this client.\n *\n * @param {Boolean} close if `true`, closes the underlying connection\n * @return {Socket} self\n * @api public\n */\n\nSocket.prototype.disconnect = function(close){\n  if (!this.connected) return this;\n  if (close) {\n    this.client.disconnect();\n  } else {\n    this.packet({ type: parser.DISCONNECT });\n    this.onclose('server namespace disconnect');\n  }\n  return this;\n};\n\n/**\n * Sets the compress flag.\n *\n * @param {Boolean} compress if `true`, compresses the sending data\n * @return {Socket} self\n * @api public\n */\n\nSocket.prototype.compress = function(compress){\n  this.flags.compress = compress;\n  return this;\n};\n\n/**\n * Sets the binary flag\n *\n * @param {Boolean} Encode as if it has binary data if `true`, Encode as if it doesnt have binary data if `false`\n * @return {Socket} self\n * @api public\n */\n\n Socket.prototype.binary = function (binary) {\n   this.flags.binary = binary;\n   return this;\n };\n\n/**\n * Dispatch incoming event to socket listeners.\n *\n * @param {Array} event that will get emitted\n * @api private\n */\n\nSocket.prototype.dispatch = function(event){\n  debug('dispatching an event %j', event);\n  var self = this;\n  function dispatchSocket(err) {\n    process.nextTick(function(){\n      if (err) {\n        return self.error(err.data || err.message);\n      }\n      emit.apply(self, event);\n    });\n  }\n  this.run(event, dispatchSocket);\n};\n\n/**\n * Sets up socket middleware.\n *\n * @param {Function} middleware function (event, next)\n * @return {Socket} self\n * @api public\n */\n\nSocket.prototype.use = function(fn){\n  this.fns.push(fn);\n  return this;\n};\n\n/**\n * Executes the middleware for an incoming event.\n *\n * @param {Array} event that will get emitted\n * @param {Function} last fn call in the middleware\n * @api private\n */\nSocket.prototype.run = function(event, fn){\n  var fns = this.fns.slice(0);\n  if (!fns.length) return fn(null);\n\n  function run(i){\n    fns[i](event, function(err){\n      // upon error, short-circuit\n      if (err) return fn(err);\n\n      // if no middleware left, summon callback\n      if (!fns[i + 1]) return fn(null);\n\n      // go on to next\n      run(i + 1);\n    });\n  }\n\n  run(0);\n};\n"]},"metadata":{},"sourceType":"script"}